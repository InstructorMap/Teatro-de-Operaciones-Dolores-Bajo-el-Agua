<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Comando | Teatro de Operaciones DBA2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Exo+2:wght@300;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            --bg-deep: #020405; 
            --hydro-cyan: #00e5ff; 
            --rescue-orange: #ff4500; 
        }
        body { background-color: #0a0a0a; font-family: 'Exo 2', sans-serif; color: white; }

        /* INPUTS */
        .input-tactical {
            background: rgba(255,255,255,0.05);
            border: 1px solid #333;
            color: white;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .input-tactical:focus { border-color: var(--hydro-cyan); outline: none; }

        /* CARNET PREVIEW (Estilo Vertical ID) */
        #carnet-container {
            width: 400px; 
            height: 650px;
            background: #020405;
            position: relative;
            overflow: hidden;
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .carnet-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('inundacion2.jpg'); 
            background-size: cover; background-position: center;
            opacity: 0.25; filter: grayscale(100%);
            z-index: 1;
        }

        /* HEADER & FOOTER STRIPS */
        .c-header, .c-footer {
            position: relative; z-index: 10;
            background: rgba(5,8,10, 0.95);
            display: flex; justify-content: center; align-items: center;
            padding: 5px;
        }
        .c-header { height: 70px; border-bottom: 2px solid var(--hydro-cyan); }
        .c-footer { height: 70px; border-top: 2px solid var(--rescue-orange); }

        /* LOGOS */
        .logo-row { display: flex; gap: 10px; }
        .logo-img { height: 35px; object-fit: contain; background: rgba(255,255,255,0.1); border-radius: 3px; padding: 3px; }

        /* BODY CARNET */
        .c-body {
            position: relative; z-index: 10;
            flex-grow: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; text-align: center;
        }

        /* FOTO ALUMNO */
        .student-photo-frame {
            width: 140px; height: 140px;
            border: 3px solid var(--rescue-orange);
            background: #111;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.2);
        }
        #preview-img { width: 100%; height: 100%; object-fit: cover; }

        /* DATOS TEXTO */
        .c-title { font-family: 'Black Ops One'; font-size: 1.8rem; line-height: 1; margin-bottom: 5px; text-transform: uppercase; }
        .c-role { color: var(--hydro-cyan); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 15px; }
        
        .c-data-box { background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 4px; border-left: 3px solid var(--hydro-cyan); width: 90%; margin-bottom: 15px; }
        .c-name { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; line-height: 1.1; }
        .c-dni { color: #aaa; font-size: 0.9rem; margin-top: 2px; }

        /* QR */
        .c-qr-frame {
            background: white; padding: 5px; border-radius: 4px;
            display: inline-block;
        }
        #qr-img-render { width: 80px; height: 80px; display: block; }

    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <div class="w-full md:w-1/3 bg-gray-900 p-6 overflow-y-auto border-r border-gray-800">
        <h2 class="text-2xl font-bold mb-6 text-orange-500 font-[Black Ops One]">PANEL DE COMANDO</h2>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 uppercase">Nombre Completo</label>
                <input type="text" id="inp-name" class="input-tactical" placeholder="EJ: MARCELO PATRI" onkeyup="updateCarnet()">
            </div>
            
            <div>
                <label class="text-xs text-gray-400 uppercase">DNI / ID (Para el QR)</label>
                <input type="text" id="inp-dni" class="input-tactical" placeholder="EJ: 20300400" onkeyup="updateCarnet()">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase">Rol / Rango</label>
                <input type="text" id="inp-role" class="input-tactical" value="OPERADOR TÁCTICO" onkeyup="updateCarnet()">
            </div>

            <div>
                <label class="text-xs text-gray-400 uppercase">Foto de Perfil</label>
                <input type="file" id="inp-photo" class="input-tactical" accept="image/*" onchange="loadPhoto(event)">
            </div>

            <hr class="border-gray-700 my-4">

            <button onclick="downloadCarnet()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded transition shadow-lg">
                <i class="fas fa-download mr-2"></i> DESCARGAR CREDENCIAL
            </button>
        </div>
    </div>

    <div class="w-full md:w-2/3 bg-black flex justify-center items-center p-10 overflow-y-auto">
        
        <div id="carnet-container">
            <div class="carnet-bg" id="dynamic-bg"></div>
            
            <div class="c-header">
                <div class="logo-row" id="avales-container">Loading...</div>
            </div>

            <div class="c-body">
                <div class="c-title">DBA 2026</div>
                <div class="c-role" id="view-role">OPERADOR TÁCTICO</div>

                <div class="student-photo-frame">
                    <img id="preview-img" src="https://via.placeholder.com/150?text=FOTO" alt="Foto Alumno">
                </div>

                <div class="c-data-box">
                    <div class="c-name" id="view-name">NOMBRE DEL ALUMNO</div>
                    <div class="c-dni" id="view-dni">DNI: ---</div>
                </div>

                <div class="c-qr-frame">
                    <img id="qr-img-render" alt="QR Validación">
                </div>
            </div>

            <div class="c-footer">
                <div class="logo-row" id="sponsors-container">Loading...</div>
            </div>
        </div>

    </div>

    <script>
        // === CONFIGURACIÓN CRÍTICA ===
        // Aquí definimos el nuevo dominio para que el QR funcione bien
        const BASE_URL = "https://teatro-de-operaciones-dba2026.vercel.app/";
        
        const SB_URL = 'https://bqhitoqdfzjzqfcltgap.supabase.co';
        const SB_KEY = 'sb_publishable__uctuloHzMPp2GK5KPKgjQ_7LGlZ9E6';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            updateCarnet(); // Generar QR inicial
            loadData();     // Cargar logos
        });

        // 1. ACTUALIZAR DATOS EN TIEMPO REAL
        function updateCarnet() {
            const name = document.getElementById('inp-name').value || 'NOMBRE DEL ALUMNO';
            const dni = document.getElementById('inp-dni').value || '---';
            const role = document.getElementById('inp-role').value || 'OPERADOR TÁCTICO';

            document.getElementById('view-name').innerText = name.toUpperCase();
            document.getElementById('view-dni').innerText = 'DNI: ' + dni;
            document.getElementById('view-role').innerText = role.toUpperCase();

            generateQR(dni);
        }

        // 2. GENERAR QR CON EL NUEVO DOMINIO
        function generateQR(dni) {
            // Limpia caracteres no numéricos para la URL
            const cleanDni = dni.replace(/\D/g,'');
            // URL de validación (apunta a tu nuevo Vercel)
            const validationUrl = `${BASE_URL}?dni=${cleanDni}`;
            
            var qr = new QRious({
                value: validationUrl,
                size: 200,
                level: 'H'
            });
            
            // Inyectar en la imagen
            document.getElementById('qr-img-render').src = qr.toDataURL();
        }

        // 3. CARGAR FOTO DE USUARIO
        function loadPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // 4. CARGAR LOGOS DESDE SUPABASE
        async function loadData() {
            try {
                let { data, error } = await sb.from('sitio_config').select('datos').eq('id', 1).single();
                if (data && data.datos) {
                    const DB = data.datos;
                    if(DB.config.bg) document.getElementById('dynamic-bg').style.backgroundImage = `url('${DB.config.bg}')`;
                    
                    renderLogos('avales-container', DB.avales);
                    renderLogos('sponsors-container', DB.sponsors);
                }
            } catch (err) { console.error(err); }
        }

        function renderLogos(containerId, list) {
            const div = document.getElementById(containerId);
            if(list && list.length > 0) {
                div.innerHTML = list.map(item => `<img src="${item.img}" class="logo-img" crossorigin="anonymous">`).join('');
            }
        }

        // 5. DESCARGAR IMAGEN (CON PAUSA DE SEGURIDAD)
        function downloadCarnet() {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GENERANDO...';
            btn.disabled = true;

            const node = document.getElementById('carnet-container');
            
            // Pausa de 800ms para asegurar renderizado de QR y Foto
            setTimeout(() => {
                html2canvas(node, {
                    scale: 3, 
                    useCORS: true, 
                    allowTaint: true,
                    backgroundColor: '#020405',
                    logging: false
                }).then(canvas => {
                    const nameFile = document.getElementById('inp-name').value.replace(/\s+/g, '_') || 'Carnet';
                    const link = document.createElement('a');
                    link.download = `Credencial_${nameFile}.jpg`;
                    link.href = canvas.toDataURL("image/jpeg", 0.95);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }).catch(err => {
                    console.error("Error descarga:", err);
                    btn.innerHTML = 'ERROR';
                    setTimeout(() => { btn.innerHTML = originalText; btn.disabled = false; }, 2000);
                });
            }, 800);
        }
    </script>
</body>
</html>
