<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Credencial | DBA2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Exo+2:wght@300;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --bg-deep: #020405; --hydro-cyan: #00e5ff; --rescue-orange: #ff4500; }
        body { background-color: #0a0a0a; font-family: 'Exo 2', sans-serif; color: white; }

        /* ESTILOS DEL CARNET */
        #carnet-container {
            width: 400px; height: 650px; background: #020405; position: relative;
            overflow: hidden; border: 1px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .carnet-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('inundacion2.jpg'); background-size: cover; opacity: 0.25; filter: grayscale(100%); z-index: 1;
        }
        .c-header, .c-footer { position: relative; z-index: 10; background: rgba(5,8,10, 0.95); display: flex; justify-content: center; align-items: center; padding: 5px; }
        .c-header { height: 70px; border-bottom: 2px solid var(--hydro-cyan); }
        .c-footer { height: 70px; border-top: 2px solid var(--rescue-orange); }
        .logo-img { height: 35px; object-fit: contain; background: rgba(255,255,255,0.1); border-radius: 3px; padding: 3px; margin: 0 5px; }
        .c-body { position: relative; z-index: 10; flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; text-align: center; }
        .student-photo-frame { width: 140px; height: 140px; border: 3px solid var(--rescue-orange); background: #111; margin-bottom: 15px; overflow: hidden; box-shadow: 0 0 20px rgba(255, 69, 0, 0.2); }
        #preview-img { width: 100%; height: 100%; object-fit: cover; }
        .c-title { font-family: 'Black Ops One'; font-size: 1.8rem; line-height: 1; margin-bottom: 5px; text-transform: uppercase; }
        .c-role { color: var(--hydro-cyan); font-weight: 800; letter-spacing: 2px; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 15px; }
        .c-data-box { background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 4px; border-left: 3px solid var(--hydro-cyan); width: 90%; margin-bottom: 15px; }
        .c-name { font-size: 1.2rem; font-weight: bold; text-transform: uppercase; line-height: 1.1; }
        .c-dni { color: #aaa; font-size: 0.9rem; margin-top: 2px; }
        .c-qr-frame { background: white; padding: 5px; border-radius: 4px; display: inline-block; }
        #qr-img-render { width: 80px; height: 80px; display: block; }
        
        /* ESTILO INPUTS BLOQUEADOS */
        .input-tactical { background: rgba(255,255,255,0.05); border: 1px solid #333; color: white; padding: 10px; width: 100%; border-radius: 4px; margin-bottom: 10px; }
        .input-locked { opacity: 0.5; cursor: not-allowed; border-color: #444; background: #111; color: #888; font-weight: bold; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <div class="w-full md:w-1/3 bg-gray-900 p-6 overflow-y-auto border-r border-gray-800">
        <h2 class="text-2xl font-bold mb-2 text-cyan-400 font-[Black Ops One]">CREDENCIAL OFICIAL</h2>
        <p class="text-gray-400 text-sm mb-6">Tus datos han sido validados por el sistema.</p>
        
        <div class="space-y-4">
            <div>
                <label class="text-xs text-gray-500 uppercase font-bold"><i class="fas fa-lock mr-1"></i> Nombre Completo (Verificado)</label>
                <input type="text" id="inp-name" class="input-tactical input-locked" placeholder="ESPERANDO DATOS..." readonly>
            </div>
            
            <div>
                <label class="text-xs text-gray-500 uppercase font-bold"><i class="fas fa-lock mr-1"></i> DNI / ID (Verificado)</label>
                <input type="text" id="inp-dni" class="input-tactical input-locked" placeholder="ESPERANDO DATOS..." readonly>
            </div>

            <div>
                <label class="text-xs text-gray-500 uppercase font-bold"><i class="fas fa-lock mr-1"></i> Rol Asignado</label>
                <input type="text" id="inp-role" class="input-tactical input-locked" value="OPERADOR T√ÅCTICO" readonly>
            </div>

            <div class="bg-gray-800 p-4 rounded border border-orange-900/50 shadow-[0_0_15px_rgba(255,69,0,0.1)]">
                <label class="text-xs text-orange-500 uppercase font-bold mb-2 block animate-pulse">üëâ PASO √öNICO: Subir Foto Selfie</label>
                <input type="file" id="inp-photo" class="text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-500 cursor-pointer" accept="image/*" onchange="loadPhoto(event)">
            </div>

            <hr class="border-gray-700 my-4">

            <button onclick="processAndDownload()" id="btn-action" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-bold py-4 px-4 rounded shadow-lg flex items-center justify-center gap-2 transform transition hover:scale-[1.02]">
                <i class="fas fa-id-card"></i> GENERAR Y DESCARGAR
            </button>
            <p class="text-center text-xs text-gray-500 mt-2">Al descargar, confirmar√°s tu asistencia.</p>
        </div>
    </div>

    <div class="w-full md:w-2/3 bg-black flex justify-center items-center p-10 overflow-y-auto">
        <div id="carnet-container">
            <div class="carnet-bg" id="dynamic-bg"></div>
            <div class="c-header"><div class="logo-row" id="avales-container"></div></div>
            <div class="c-body">
                <div class="c-title">DBA 2026</div>
                <div class="c-role" id="view-role">OPERADOR T√ÅCTICO</div>
                <div class="student-photo-frame">
                    <img id="preview-img" src="https://via.placeholder.com/150?text=FOTO+PENDIENTE" alt="Foto">
                </div>
                <div class="c-data-box">
                    <div class="c-name" id="view-name">---</div>
                    <div class="c-dni" id="view-dni">DNI: ---</div>
                </div>
                <div class="c-qr-frame"><img id="qr-img-render" alt="QR"></div>
            </div>
            <div class="c-footer"><div class="logo-row" id="sponsors-container"></div></div>
        </div>
    </div>

    <script>
        // === CONFIGURACI√ìN ===
        const BASE_URL = "https://teatro-de-operaciones-dba2026.vercel.app/"; 
        const SB_URL = 'https://bqhitoqdfzjzqfcltgap.supabase.co';
        const SB_KEY = 'sb_publishable__uctuloHzMPp2GK5KPKgjQ_7LGlZ9E6';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        let currentPhotoBase64 = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos OBLIGATORIAMENTE de la URL (Bloqueados)
            const params = new URLSearchParams(window.location.search);
            const nameUrl = params.get('name');
            const dniUrl = params.get('dni');

            if(nameUrl && dniUrl) {
                document.getElementById('inp-name').value = decodeURIComponent(nameUrl).toUpperCase();
                document.getElementById('inp-dni').value = dniUrl;
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Acceso Denegado',
                    text: 'No se detectaron credenciales de acceso v√°lidas. Ingresa desde el link oficial.',
                    allowOutsideClick: false,
                    showConfirmButton: false
                });
            }
            
            updateCarnet();
            loadData();
        });

        // 1. ACTUALIZAR VISTA (Solo visual, no inputs)
        function updateCarnet() {
            const name = document.getElementById('inp-name').value || '---';
            const dni = document.getElementById('inp-dni').value || '---';
            const role = document.getElementById('inp-role').value;

            document.getElementById('view-name').innerText = name;
            document.getElementById('view-dni').innerText = 'DNI: ' + dni;
            document.getElementById('view-role').innerText = role;

            // Generar QR (Apunta al validador)
            const cleanDni = dni.replace(/\D/g,'');
            if(cleanDni) {
                const validationUrl = `${BASE_URL}?dni=${cleanDni}`;
                var qr = new QRious({ value: validationUrl, size: 200, level: 'H' });
                document.getElementById('qr-img-render').src = qr.toDataURL();
            }
        }

        // 2. CARGAR Y OPTIMIZAR FOTO
        function loadPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    resizeImage(e.target.result, 150).then(resized => { currentPhotoBase64 = resized; });
                }
                reader.readAsDataURL(file);
            }
        }

        function resizeImage(base64Str, maxWidth = 150) {
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                    canvas.width = width; canvas.height = height;
                    let ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            });
        }

        // 3. GUARDAR Y DESCARGAR
        async function processAndDownload() {
            const btn = document.getElementById('btn-action');
            const name = document.getElementById('inp-name').value;
            const dni = document.getElementById('inp-dni').value;
            const role = document.getElementById('inp-role').value;

            if(!name || !dni || dni === '---') return Swal.fire('Error de Datos', 'El link de acceso parece inv√°lido.', 'error');
            if(!currentPhotoBase64) return Swal.fire('Falta Foto', 'Es obligatorio subir una foto selfie.', 'warning');

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> REGISTRANDO...';
            btn.disabled = true;

            try {
                // A. Guardar en Nube (RENAM)
                const { error } = await sb.from('alumnos').upsert([
                    { dni: dni, nombre: name, rol: role, foto: currentPhotoBase64, estado: 'ACTIVO' }
                ], { onConflict: 'dni' });

                if (error) throw error;

                // B. Generar Imagen
                btn.innerHTML = '<i class="fas fa-camera"></i> IMPRIMIENDO...';
                await new Promise(r => setTimeout(r, 500));
                
                const canvas = await html2canvas(document.getElementById('carnet-container'), {
                    scale: 3, useCORS: true, allowTaint: true, backgroundColor: '#020405', logging: false
                });

                // C. Descargar
                const link = document.createElement('a');
                link.download = `Credencial_DBA_${name.replace(/\s/g,'_')}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                Swal.fire({
                    icon: 'success',
                    title: '¬°Credencial Activada!',
                    text: 'Tu registro ha sido completado exitosamente.',
                    confirmButtonColor: '#00e5ff'
                });

            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'Error de conexi√≥n. Intenta nuevamente.', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function loadData() {
            try {
                let { data } = await sb.from('sitio_config').select('datos').eq('id', 1).single();
                if (data?.datos) {
                    const DB = data.datos;
                    if(DB.config.bg) document.getElementById('dynamic-bg').style.backgroundImage = `url('${DB.config.bg}')`;
                    renderLogos('avales-container', DB.avales);
                    renderLogos('sponsors-container', DB.sponsors);
                }
            } catch (err) {}
        }
        function renderLogos(id, list) {
            if(list && list.length) document.getElementById(id).innerHTML = list.map(i => `<img src="${i.img}" class="logo-img" crossorigin="anonymous">`).join('');
        }
    </script>
</body>
</html>
